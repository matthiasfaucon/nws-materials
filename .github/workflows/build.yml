name: Runs All Unit tests
run-name: Build and Tests

on: [push]

jobs:
  build:
    needs:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: "npm"
      - run: |
          npm i
          npm run build
  build-prisma:
    needs: [build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: "npm"
      - run: |
          npx prisma migrate deploy
  build-docker:
    needs: [build, build-prisma]
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
    runs-on: ubuntu-latest
    steps:
      - name: Login to Github Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io # lien pour registry github
          username: ${{ github.actor }} # actor github
          password: ${{ secrets.GITHUB_TOKEN }} # Génère un token de Github

      - name: Build and push to Github Repository
        uses: docker/build-push-action@v3
        with:
          push: true # push image dans le Github Registry
          tags: ghcr.io/matthiasfaucon/nws-material:latest # mettre un tag à l'image dans le Github Registry
          target: nws-material # sélectionner le Dockerfile
  test:
    needs: [build-docker]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: "npm"
      - run: |
          npm run test